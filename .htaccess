# Enable mod_rewrite engine
RewriteEngine On

# Prevent direct access to the home page ("/") - COMMENT OUT or REMOVE if not needed
# RewriteCond %{REQUEST_URI} ^/$
# RewriteRule ^$ - [F,L]

# Do not apply rewrites to existing directories or files
RewriteCond %{REQUEST_FILENAME} !-d               # Don't rewrite directories
RewriteCond %{REQUEST_FILENAME} !-f               # Don't rewrite existing files (e.g., images, CSS)

# General rewrite rules for URLs that need to be processed as PHP (without .php extension)
RewriteRule ^(admin/([a-zA-Z0-9_-]+))$ admin/$2.php [NC,L]
RewriteRule ^(index|about|contact|register_instructor|step_register|login|instructor-reg|student-reg|student-signup|step-123|exam|finished|home)$ $1.php [NC,L]

# Redirect .php URLs to clean URLs (for SEO purposes), EXCEPT for "student-signup.php"
RewriteCond %{THE_REQUEST} \s/([^/]+)\.php [NC]
RewriteCond %{REQUEST_URI} !^/student-signup.php$  # Exclude student-signup.php from redirection
RewriteRule ^([^/]+)\.php$ /$1 [R=301,L]    # Redirect .php URLs to clean URLs without .php

# Additional rules: Redirect "exam.php" to the clean URL "exam", "finished.php" to "finished", "home.php" to "home"
RewriteCond %{THE_REQUEST} \s/exam\.php$ [NC]
RewriteRule ^exam\.php$ /exam [R=301,L]    # Redirect exam.php to exam without .php

RewriteCond %{THE_REQUEST} \s/finished\.php$ [NC]
RewriteRule ^finished\.php$ /finished [R=301,L]    # Redirect finished.php to finished without .php

RewriteCond %{THE_REQUEST} \s/home\.php$ [NC]
RewriteRule ^home\.php$ /home [R=301,L]    # Redirect home.php to home without .php

# Add rule to redirect error_page.php to clean URL "error_page" without .php
RewriteCond %{THE_REQUEST} \s/error_page\.php$ [NC]
RewriteRule ^error_page\.php$ /error_page [R=301,L]    # Redirect error_page.php to error_page without .php

# Force HTTPS (if using SSL)
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Prevent access to the .htaccess file
<Files .htaccess>
    Order Allow,Deny
    Deny from all
</Files>

# Block unwanted HTTP methods (e.g., TRACE, DELETE, PUT)
<Limit TRACE DELETE PUT>
    Order Deny,Allow
    Deny from all
</Limit>

# Disable directory listing
Options -Indexes

# Block access to sensitive files like .env, php.ini, etc.
<FilesMatch "(^\.|\.env|\.git|\.gitignore|\.ini)">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Set HTTP Security Headers
Header set X-Content-Type-Options "nosniff"
Header set X-XSS-Protection "1; mode=block"
Header set X-Frame-Options "DENY"
Header set Referrer-Policy "no-referrer"
Header set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self'; object-src 'none';"

# Prevent image hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|bmp|webp)$ - [F,NC,L]

# Redirect www to non-www (or vice versa)
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]
